[
  {
    "id": "gr-networking-terraform-links",
    "topic": "networking",
    "cloud": null,
    "iac": "terraform",
    "check_type": "links/dr",
    "scope": "senior/terraform",
    "requires_tools": [
      "python3"
    ],
    "signals": [
      "alias_missing",
      "secondary_usage_missing",
      "reverse_link_missing",
      "route_assoc_missing",
      "private_dns_link_missing"
    ],
    "command": "python - <<'PY'\nimport os, re, sys, json\nfrom pathlib import Path\nimport hcl2\nFAIL='guardrail unmet: required links missing'\nPASS='guardrail met'\nroot_arg=os.environ.get('IAC_ROOT','senior/terraform')\nROOT=Path(root_arg)\nif not ROOT.exists():\n    print(FAIL)\n    print('issues: iac_path_missing=1')\n    sys.exit(1)\n\nalias_missing=0\nsecondary_usage_missing=0\nreverse_link_missing=0\nroute_assoc_missing=0\nprivate_dns_link_missing=0\n\ntexts=[]\ndocs=[]\nfor tf in sorted(ROOT.rglob('*.tf')):\n    try:\n        text=tf.read_text(encoding='utf-8', errors='ignore')\n    except Exception:\n        continue\n    texts.append(text)\n    try:\n        docs.append(hcl2.loads(text))\n    except Exception:\n        continue\ntext='\\n'.join(texts)\njs='\\n'.join(json.dumps(d, default=str) for d in docs)\nhay=text + '\\n' + js\n\n# provider alias and usage\nif re.search(r'provider\\s+\"azurerm\"[^}]*alias\\s*=\\s*\"secondary\"', hay, re.S|re.I) is None:\n    alias_missing=1\nif re.search(r'providers\\s*=\\s*\\{[^}]*azurerm\\s*=\\s*azurerm\\.secondary', hay, re.S|re.I) is None and re.search(r'provider\\s*=\\s*azurerm\\.secondary', hay, re.S|re.I) is None:\n    secondary_usage_missing=1\n\n# Count resource blocks (offline-safe; modules/for_each are not expanded)\ndef _count_blocks(rtype):\n    return len(re.findall(r'resource\\s+\"{}\"\\s+\"'.format(re.escape(rtype)), text, re.I))\n\ndef _resource_has_for_each(rtype):\n    pat = r'resource\\s+\"{}\"\\s+\"[^\\\"]+\"\\s*\\{{[^}}]*\\bfor_each\\b'.format(re.escape(rtype))\n    return re.search(pat, text, re.I | re.S) is not None\n\ndef _module_has_for_each(token):\n    pat = r'module\\s+\"[^\\\"]+\"\\s*\\{{[^}}]*source\\s*=\\s*\"[^\\\"]*{}[^\\\"]*\"[^}}]*\\bfor_each\\b'.format(re.escape(token))\n    return re.search(pat, text, re.I | re.S) is not None\n\npeering_blocks = _count_blocks('azurerm_virtual_network_peering')\nroute_assoc_blocks = _count_blocks('azurerm_subnet_route_table_association')\ndns_link_blocks = _count_blocks('azurerm_private_dns_zone_virtual_network_link')\n\npeering_for_each = _resource_has_for_each('azurerm_virtual_network_peering') or _module_has_for_each('modules/peering')\nroute_assoc_for_each = _resource_has_for_each('azurerm_subnet_route_table_association')\ndns_link_for_each = _resource_has_for_each('azurerm_private_dns_zone_virtual_network_link')\n\n# Reverse link heuristic (both directions referenced)\nprimary_to_secondary = re.search(r'remote_virtual_network_id\\s*=.*(secondary|hub_secondary|sec)', hay, re.S|re.I)\nsecondary_to_primary = re.search(r'remote_virtual_network_id\\s*=.*(primary|hub_primary|pri)', hay, re.S|re.I)\nif not (primary_to_secondary and secondary_to_primary):\n    reverse_link_missing = 1\n\n# Minimum block counts + for_each scaling\nif peering_blocks < 1 or not peering_for_each:\n    reverse_link_missing = 1\nif route_assoc_blocks < 2 or not route_assoc_for_each:\n    route_assoc_missing = 1\nif dns_link_blocks < 2 or not dns_link_for_each:\n    private_dns_link_missing = 1\n\nif any([alias_missing, secondary_usage_missing, reverse_link_missing, route_assoc_missing, private_dns_link_missing]):\n    print(FAIL)\n    print(\n        \"issues: alias_missing={}, secondary_usage_missing={}, reverse_link_missing={}, route_assoc_missing={}, private_dns_link_missing={}, peering_blocks={}, route_assoc_blocks={}, dns_link_blocks={}, peering_for_each={}, route_assoc_for_each={}, dns_link_for_each={}\"\n        .format(\n            alias_missing,\n            secondary_usage_missing,\n            reverse_link_missing,\n            route_assoc_missing,\n            private_dns_link_missing,\n            peering_blocks,\n            route_assoc_blocks,\n            dns_link_blocks,\n            int(bool(peering_for_each)),\n            int(bool(route_assoc_for_each)),\n            int(bool(dns_link_for_each)),\n        )\n    )\n    sys.exit(1)\n\nprint(PASS)\nPY\n",
    "fail_message": "guardrail unmet: required links missing",
    "source": "opa-contrib + checkov patterns",
    "license": "Apache-2.0",
    "notes": "Offline-safe heuristic: block-aware counts with for_each scaling, requires alias + secondary usage, reverse links, route associations, and private DNS VNet links; aggregated signals only; scoped to senior/terraform. Requires python-hcl2."
  },
  {
    "id": "gr-security-terraform-lpv",
    "topic": "security",
    "cloud": null,
    "iac": "terraform",
    "check_type": "policy_lpv",
    "scope": "senior/terraform",
    "requires_tools": [
      "python3"
    ],
    "signals": [
      "high_risk_verbs",
      "broad_scopes",
      "missing_not_actions",
      "overbroad_builtins",
      "secondary_missing"
    ],
    "command": "python - <<'PY'\nimport os, re, sys, json\nfrom pathlib import Path\nimport hcl2\nFAIL='guardrail unmet: least-privilege policy violation'\nPASS='guardrail met'\nroot_arg=os.environ.get('IAC_ROOT','senior/terraform')\nROOT=Path(root_arg)\nif not ROOT.exists():\n    print(FAIL)\n    print('issues: iac_path_missing=1')\n    sys.exit(1)\n\nhigh_risk_verbs=broad_scopes=missing_not_actions=overbroad_builtins=secondary_missing=0\nHIGH_RISK=re.compile(r\"Microsoft\\\\.(Authorization/.*/write|KeyVault/.*/delete)\", re.I)\nASSIGNABLE=re.compile(r\"assignable_scopes\\s*=\\s*\\\\[(.*?)\\\\]\", re.S|re.I)\nPERMS=re.compile(r\"permissions\\s*{(.*?)}\", re.S|re.I)\nACTIONS=re.compile(r\"actions\\s*=\\s*\\\\[(.*?)\\\\]\", re.S|re.I)\nNOT_ACTIONS=re.compile(r\"not_actions\\s*=\\s*\\\\[(.*?)\\\\]\", re.S|re.I)\nOWNER_CONTRIB=re.compile(r\"role_definition_name\\s*=\\s*\\\"(?:Owner|Contributor)\\\"\", re.I)\nSECONDARY=re.compile(r\"\\balias\\s*=\\s*\\\"secondary\\\"|secondary_location|secondary_region|dr_\", re.I)\nsecondary_seen=False\n\ntexts=[]\ndocs=[]\nfor tf in ROOT.rglob('*.tf'):\n    try:\n        text=tf.read_text(errors='ignore')\n    except Exception:\n        continue\n    texts.append(text)\n    try:\n        docs.append(hcl2.loads(text))\n    except Exception:\n        continue\ntext='\\n'.join(texts)\njs='\\n'.join(json.dumps(d, default=str) for d in docs)\nhay=text + '\\n' + js\n\nif SECONDARY.search(hay):\n    secondary_seen=True\nfor perm in PERMS.finditer(hay):\n    block=perm.group(1)\n    actions=ACTIONS.search(block)\n    if actions and HIGH_RISK.search(actions.group(1)):\n        high_risk_verbs+=1\n    if NOT_ACTIONS.search(block) is None:\n        missing_not_actions+=1\nfor scopes in ASSIGNABLE.finditer(hay):\n    if re.search(r\"/subscriptions/|/providers/microsoft\\.authorization\", scopes.group(1), re.I):\n        broad_scopes+=1\nif OWNER_CONTRIB.search(hay):\n    overbroad_builtins+=1\n\nif not secondary_seen:\n    secondary_missing=1\n\nif any([high_risk_verbs,broad_scopes,missing_not_actions,overbroad_builtins,secondary_missing]):\n    print(FAIL)\n    print(\n        \"issues: \"\n        f\"high_risk_verbs={high_risk_verbs}, \"\n        f\"broad_scopes={broad_scopes}, \"\n        f\"missing_not_actions={missing_not_actions}, \"\n        f\"overbroad_builtins={overbroad_builtins}, \"\n        f\"secondary_missing={secondary_missing}\"\n    )\n    sys.exit(1)\nprint(PASS)\nPY\n",
    "fail_message": "guardrail unmet: least-privilege policy violation",
    "source": "checkov rule patterns + azure role_definition",
    "license": "Apache-2.0",
    "notes": "Offline-safe LPV heuristic: high-risk verbs, broad scopes, missing not_actions, over-broad built-ins; aggregated counts only (no file paths). Requires python-hcl2."
  },
  {
    "id": "gr-observability-terraform-telemetry",
    "topic": "observability",
    "cloud": null,
    "iac": "terraform",
    "check_type": "telemetry",
    "command": "python - <<'PY'\nimport os, json, re, sys\nfrom pathlib import Path\nimport hcl2\nFAIL='guardrail unmet: telemetry missing'\nPASS='guardrail met'\nroot_arg=os.environ.get('IAC_ROOT','senior/terraform')\nROOT=Path(root_arg)\ntexts=[]\ndocs=[]\nfor tf in sorted(ROOT.glob('*.tf')):\n    try:\n        text=tf.read_text(encoding='utf-8', errors='ignore')\n    except Exception:\n        continue\n    texts.append(text)\n    try:\n        docs.append(hcl2.loads(text))\n    except Exception:\n        continue\nhay='\\n'.join(texts) + '\\n' + '\\n'.join(json.dumps(d, default=str) for d in docs)\npattern=r'resource\\s+\\\"(azurerm_monitor_diagnostic_setting|azurerm_log_analytics_workspace|aws_cloudwatch_log_group|aws_cloudwatch_metric_alarm|google_logging_project_sink|google_monitoring_alert_policy)\\\"'\nif re.search(pattern, hay, re.I):\n    print(PASS)\n    sys.exit(0)\nprint(FAIL)\nsys.exit(1)\nPY\n",
    "fail_message": "guardrail unmet: telemetry missing",
    "source": "checkov patterns",
    "license": "Apache-2.0",
    "notes": "Offline-safe heuristic requiring at least one telemetry resource. Requires python-hcl2."
  },
  {
    "id": "gr-cost-tags-fullset-terraform",
    "topic": "cost",
    "cloud": null,
    "iac": "terraform",
    "check_type": "tags_fullset",
    "requires_tools": [
      "python3"
    ],
    "command": "python - <<'PY'\nimport json, re, sys\nfrom pathlib import Path\nimport hcl2\nFAIL='guardrail unmet: required tags missing'\nPASS='guardrail met'\nROOT=Path('.')\ntexts=[]\ndocs=[]\nfor tf in sorted(ROOT.rglob('*.tf')):\n    try:\n        text=tf.read_text(encoding='utf-8', errors='ignore')\n    except Exception:\n        continue\n    texts.append(text)\n    try:\n        docs.append(hcl2.loads(text))\n    except Exception:\n        continue\nhay='\\n'.join(texts) + '\\n' + '\\n'.join(json.dumps(d, default=str) for d in docs)\npattern='(?s)(?=.*\\bOwner\\b)(?=.*\\bCostCenter\\b)(?=.*\\bEnv\\b)(?=.*\\bProject\\b)'\ncount=len(re.findall(pattern, hay, re.I))\nif count >= 1:\n    print(PASS)\n    sys.exit(0)\nprint(FAIL)\nprint(\"issues: pattern_count={}\".format(count))\nsys.exit(1)\nPY\n",
    "fail_message": "guardrail unmet: required tags missing",
    "source": "offline python-hcl2 heuristic",
    "license": null,
    "notes": "Offline-safe heuristic. Requires python-hcl2. Count-based check."
  }
]
